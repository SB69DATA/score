var SBRS=new function(){this.parse=function(e){function r(e){return 0===e.length?!1:"#"===e.charAt(0)?!1:!0}var a=e.split(/\r\n|\r|\n/g),t={};t.title="no title",t.artist="",t.sound="",t.soundVolume=1,t.offset=0,t.level=1,t.bpm=[],t.marker=[],t.measure=[],t.measureCount=0,t.markerCount=0,t.comboCount=0,t.judgeRange=1,t.scroll=1,t.fiverGaugeLength=0,t.fiver=0,t.fiverHigh=0;var n=0,o=!0,u=0,i=0,l=[-1,-1,-1],m=4,s=4,h=0,f=1;for(var c in a){var g=a[c];if(-1!==g.indexOf("//")&&(g=g.substring(0,g.indexOf("//"))),0!==g.length)if("#"===g.charAt(0)){if(null!==g.match(/^#TITLE:/i))t.title=g.slice("#TITLE:".length);else if(null!==g.match(/^#ARTIST:/i))t.artist=g.slice("#ARTIST:".length);else if(null!==g.match(/^#SOUND:/i))t.sound=g.slice("#SOUND:".length);else if(null!==g.match(/^#SOUNDVOLUME:/i))t.soundVolume=parseFloat(g.slice("#SOUNDVOLUME:".length));else if(null!==g.match(/^#OFFSET:/i))t.offset=parseFloat(1e3*g.slice("#OFFSET:".length));else if(null!==g.match(/^#LEVEL:/i))t.level=parseInt(g.slice("#LEVEL:".length));else if(null!==g.match(/^#SCROLL:/i))t.scroll=parseFloat(g.slice("#SCROLL:".length)),f=parseFloat(g.slice("#SCROLL:".length));else if(null!==g.match(/^#JUDGERANGE:/i))t.judgeRange=parseFloat(g.slice("#JUDGERANGE:".length));else if(null!==g.match(/^#BPM:/i)){var v={};v.value=parseFloat(g.slice("#BPM:".length)),v.measure=t.measureCount+1,v.point=u,v.time=i,t.bpm.push(v),h=v.value}else if(null!==g.match(/^#MEASURE:/i)){var p=g.slice("#MEASURE:".length).match(/([\d\-\.]+)\/([\d\-\.]+)/);null!==p&&(m=parseFloat(p[1]),s=parseFloat(p[2]))}}else if(r(g)===!0){if(o===!0){n=function(e,a){for(var t=0,n=a;","!==e[n].charAt(0)&&n<e.length-1;n++){var o=e[n];-1!==o.indexOf("//")&&(o=o.substring(0,o.indexOf("//"))),r(o)!==!1&&t++}return t}(a,c);var k={};k.value=t.measureCount+1,k.bpm=h,k.time=i,k.measureS=m,k.measureB=s,k.markerIndex=t.markerCount,t.measure.push(k),o=!1}if(","!==g.charAt(0)){for(var C=g.replace(/[^\d]/g,""),S=0;3>S&&S<C.length;S++){var d=C.charAt(S);switch(d){case"0":continue;case"1":case"2":if(-1!==l[S]){var M={};M.measure=t.measureCount+1,M.point=u/n,M.time=i,M.longCount=0,M.marker=[];var E=Math.ceil(4*t.marker[l[S]].point)/4,L=t.marker[l[S]].measure+Math.floor(E);E-=Math.floor(E);for(var R=M.measure,T=M.point;R+T>L+E;E+=.25){L+=Math.floor(E),E-=Math.floor(E);var O={};O.measure=L,O.point=E,O.time=SBRS.getTime(t,L,E),M.marker.push(O),M.longCount++}t.marker[l[S]]["long"]=M,l[S]=-1}var O={};O.lane=S+1,O.measure=t.measureCount+1,O.point=u/n,O["long"]=null,O.type=parseInt(d),O.time=i,t.marker.push(O),"2"===d&&(l[S]=t.markerCount),t.markerCount++;break;case"3":if(-1!==l[S]){var M={};M.measure=t.measureCount+1,M.point=u/n,M.time=i,M.longCount=0,M.marker=[];var E=Math.ceil(4*t.marker[l[S]].point)/4,L=t.marker[l[S]].measure+Math.floor(E);E-=Math.floor(E);for(var R=M.measure,T=M.point;R+T>L+E;E+=.25){L+=Math.floor(E),E-=Math.floor(E);var O={};O.measure=L,O.point=E,O.time=SBRS.getTime(t,L,E),M.marker.push(O),M.longCount++}t.marker[l[S]]["long"]=M,l[S]=-1}else console.warn(c+"行目のロングマーカー終端に対応するロングマーカー定義がありません");continue;default:console.warn(c+"行目のマーカー定義が異常です");continue}}i+=24e4/h*(m/s)/n,u++}else t.measure[t.measureCount].markerEndIndex=t.markerCount,u=0,t.measureCount++,o=!0}}o===!1&&(t.measure[t.measureCount].markerEndIndex=t.markerCount,u=0,t.measureCount++,o=!0),t.fiverGaugeLength=Math.floor(2*t.markerCount*.8),t.fiver=Math.ceil(t.fiverGaugeLength/4),t.fiverHigh=Math.ceil(t.fiverGaugeLength/28);for(var c=0;c<t.markerCount;c++){if(null!==t.marker[c]["long"]){for(var S=0;S<t.marker[c]["long"].longCount;S++)t.marker[c]["long"].marker[S].time=SBRS.roundTime(t.marker[c]["long"].marker[S].time);t.marker[c]["long"].time=SBRS.roundTime(t.marker[c]["long"].time)}t.marker[c].time=SBRS.roundTime(t.marker[c].time)}for(var c=0;c<t.measureCount;c++)t.measure[c].time=SBRS.roundTime(t.measure[c].time);return t},this.roundTime=function(e){return Math.floor(Math.round(1e8*e)/10)/1e7},this.getMeasurePointObject=function(e,r){for(var a=0;a<e.measureCount;a++)if(e.measure[a].time<=r&&(a+1>=e.measureCount||e.measure[a+1].time>r)){var t={};return t.point=(r-e.measure[a].time)/(24e4/e.measure[a].bpm),t.measure=e.measure[a].value+Math.floor(t.point),t.point=t.point-Math.floor(t.point),t}throw new Error("error : getMeasurePointObject()")},this.getTime=function(e,r,a){var t=e.measure[r-1].bpm,n=e.measure[r-1].time,o=e.measure[r-1].measureS/e.measure[r-1].measureS;return n+24e4/t*o*a}};